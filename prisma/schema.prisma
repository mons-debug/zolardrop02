// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id             String    @id @default(uuid())
  sku            String    @unique
  title          String
  description    String?
  images         String?
  priceCents     Int
  salePriceCents Int?
  currency       String    @default("USD")
  stock          Int
  category       String?
  tags           String?
  status         String    @default("published") // draft, published, archived
  seoTitle       String?
  seoDescription String?
  variants       Variant[]
  metadata       String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model Variant {
  id         String   @id @default(uuid())
  product    Product  @relation(fields: [productId], references: [id])
  productId  String
  color      String
  sku        String   @unique
  priceCents Int
  stock      Int
  images     String?
  metadata   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Customer {
  id          String   @id @default(uuid())
  name        String
  phone       String   @unique
  city        String?
  email       String?
  totalOrders Int      @default(0)
  totalSpent  Int      @default(0) // in cents
  tags        String? // JSON: ["VIP", "Loyal", "New"]
  notes       String? // Admin notes about customer
  isBlocked   Boolean  @default(false)
  orders      Order[]
  // Audit fields
  blockedBy   String? // User ID who blocked/unblocked
  blockedAt   DateTime?
  updatedBy   String? // User ID of last admin who updated
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Order {
  id            String    @id @default(uuid())
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id])
  userId        String?
  items         String // store [{ productId, variantId, qty, priceCents }]
  subtotalCents Int
  taxCents      Int
  shippingCents Int
  totalCents    Int
  status        String    @default("pending") // pending, confirmed, shipped, delivered, cancelled, refunded
  paymentMethod String    @default("COD")
  paymentId     String?
  refundReason  String?
  adminNotes    String?
  // Audit fields
  confirmedBy   String? // User ID who confirmed
  confirmedAt   DateTime?
  shippedBy     String? // User ID who marked as shipped
  shippedAt     DateTime?
  deliveredBy   String? // User ID who marked as delivered
  deliveredAt   DateTime?
  cancelledBy   String? // User ID who cancelled
  cancelledAt   DateTime?
  refundedBy    String? // User ID who refunded
  refundedAt    DateTime?
  updatedBy     String? // User ID of last admin who updated
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model User {
  id               String        @id @default(uuid())
  email            String        @unique
  name             String?
  role             String        @default("customer") // customer, VIEWER, MANAGER, ADMIN, SUPER_ADMIN
  passwordHash     String
  isActive         Boolean       @default(true)
  lastLogin        DateTime?
  resetToken       String?
  resetTokenExpiry DateTime?
  // Activity tracking
  totalActions     Int           @default(0) // Total admin actions performed
  lastActivity     DateTime?
  actions          AdminAction[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
}

model ArchiveCollection {
  id        String   @id @default(uuid())
  images    String // JSON array of image URLs
  title     String   @default("BORDERLINE")
  subtitle  String   @default("DROP 01")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FashionCarousel {
  id        String   @id @default(uuid())
  url       String
  alt       String
  size      String // 'small', 'medium', 'large'
  order     Int // Display order
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model HeroSlide {
  id              String   @id @default(uuid())
  title           String
  subtitle        String?
  mediaUrl        String // URL to image or video
  mediaType       String   @default("image") // 'image' or 'video'
  linkUrl         String? // Optional link when user clicks the slide
  backgroundColor String   @default("#000000") // Hex color for left side background
  textColor       String   @default("#FFFFFF") // Text color for contrast
  accentColor     String   @default("#ff5b00") // Accent color for gradients
  duration        Int      @default(5000) // Duration in milliseconds (5000 = 5 seconds)
  order           Int // Display order
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model CollectionStack {
  id              String   @id @default(uuid())
  collectionName  String   @unique // ESSENCE, FRAGMENT, RECODE
  title           String // Display title
  description     String? // Optional description
  images          String // JSON array of image URLs for the stack
  linkUrl         String? // Link when clicking "See Collection"
  autoRotateDelay Int      @default(3000) // Auto-rotate delay in milliseconds (default 3 seconds)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Newsletter {
  id             String    @id @default(uuid())
  email          String    @unique
  status         String    @default("active") // active, unsubscribed
  source         String?   @default("homepage") // Track where they signed up
  ipAddress      String?
  userAgent      String?
  metadata       String? // JSON for future integration data (Mailchimp ID, etc.)
  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model TrackingSettings {
  id                String   @id @default(uuid())
  googleAdsId       String? // Google Ads Conversion ID (AW-XXXXXXXXX)
  googleAdsLabel    String? // Conversion Label
  googleAnalyticsId String? // GA4 Measurement ID (G-XXXXXXXXX)
  facebookPixelId   String? // Meta Pixel ID
  tiktokPixelId     String? // TikTok Pixel ID
  snapchatPixelId   String? // Snapchat Pixel ID
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model AdminNotification {
  id        String    @id @default(uuid())
  type      String // 'new-order', 'low-stock', 'system'
  title     String
  message   String
  data      String? // JSON data for the notification
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([createdAt])
  @@index([isRead, createdAt])
}

model AdminAction {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  action      String // 'order.confirm', 'order.ship', 'order.cancel', 'customer.block', 'product.update', etc.
  entityType  String // 'order', 'customer', 'product', etc.
  entityId    String // ID of the affected entity
  oldValue    String? // JSON: previous state
  newValue    String? // JSON: new state
  metadata    String? // JSON: extra context (IP, user agent, etc.)
  description String? // Human-readable description
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
  @@index([entityType, entityId, createdAt])
  @@index([action, createdAt])
  @@index([createdAt])
}

model PushSubscription {
  id        String   @id @default(uuid())
  endpoint  String   @unique
  p256dh    String // Push encryption key
  auth      String // Push authentication secret
  userId    String? // Optional: associate with specific user
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}
